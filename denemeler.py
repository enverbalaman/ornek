# burasƒ± checkuser ve turmob ve xml g√ºncelleme doƒüru.

from zeep import Client
from zeep.helpers import serialize_object
import uuid
from datetime import datetime, timedelta
import json
import traceback
import base64
import os
import xml.etree.ElementTree as ET
import time
import zeep.exceptions
import random
import requests
import socket

# ƒ∞≈ülenmi≈ü faturalarƒ± takip etmek i√ßin JSON dosyasƒ±
PROCESSED_INVOICES_FILE = 'processed_invoices.json'

# Otokoc API token bilgileri
otokoc_token = None
token_expiry_time = None


def get_otokoc_token():
    """Otokoc API'den token alƒ±r"""
    global otokoc_token, token_expiry_time
    
    try:
        print("\nüîë Otokoc API'den token alƒ±nƒ±yor...")
        
        # IP bilgilerini al ve g√∂ster
        
        
        url = "https://merkezwebapi.otokoc.com.tr/STDealer/GetToken"
        payload = {
            "Username": "UrartuTrz",
            "Password": "Tsv*57139!"
        }
        
        response = requests.post(url, json=payload)
        response.raise_for_status()  # HTTP hatalarƒ±nƒ± yakala
        response_data = response.json()
        
        if 'Data' not in response_data or 'Token' not in response_data['Data']:
            print(f"‚ùå Otokoc API token alƒ±namadƒ±: Ge√ßersiz yanƒ±t formatƒ±")
            print(f"Yanƒ±t: {json.dumps(response_data, indent=2, ensure_ascii=False)}")
            return None
        
        otokoc_token = response_data['Data']['Token']
        # Token ge√ßerlilik s√ºresi 4 dakika
        token_expiry_time = datetime.now() + timedelta(minutes=4)
        print(f"‚úÖ Otokoc API'den token alƒ±ndƒ±. Ge√ßerlilik: {token_expiry_time.strftime('%H:%M:%S')}")
        return otokoc_token
    except requests.exceptions.RequestException as e:
        print(f"‚ùå Otokoc API token alma hatasƒ±: {str(e)}")
        traceback.print_exc()
        return None
    except Exception as e:
        print(f"‚ùå Otokoc API token alma hatasƒ±: {str(e)}")
        traceback.print_exc()
        return None

def check_and_refresh_token():
    """Token ge√ßerliliƒüini kontrol eder ve gerekirse yeniler"""
    global otokoc_token, token_expiry_time
    
    if not otokoc_token or not token_expiry_time or datetime.now() >= token_expiry_time:
        print("‚ö†Ô∏è Token ge√ßersiz veya s√ºresi dolmu≈ü, yenileniyor...")
        return get_otokoc_token()
    else:
        remaining_time = (token_expiry_time - datetime.now()).total_seconds()
        print(f"‚úÖ Token ge√ßerli. Kalan s√ºre: {int(remaining_time)} saniye")
        return otokoc_token

def get_invoice_data():
    """Otokoc API'den fatura verilerini √ßeker"""
    try:
        # Token kontrol√º ve yenileme
        token = check_and_refresh_token()
        if not token:
            print("‚ùå Ge√ßerli token olmadan fatura verileri √ßekilemez")
            return []
        
        print("\nüìä Otokoc API'den fatura verileri √ßekiliyor...")
        
        url = "https://merkezwebapi.otokoc.com.tr/STDealer/GetInvoiceList"
        
        # D√ºn√ºn tarihini al
        yesterday = (datetime.now() - timedelta(days=1)).strftime("%Y%m%d")
        today = datetime.now().strftime("%Y%m%d")
        
        print(f"üóìÔ∏è Tarih aralƒ±ƒüƒ±: {yesterday} - {today}")

        payload = {
            "Token": token,
            "LicenseNo": 1,
            "InvoiceDate": "",
            "StartDate": yesterday,
            "EndDate": today
        }
        
        response = requests.post(url, json=payload)
        response.raise_for_status()  # HTTP hatalarƒ±nƒ± yakala
        response_data = response.json()
        
        if response_data.get('MessageEN') == "Token is expired":
            print("‚ùå Token s√ºresi dolmu≈ü, yenileniyor...")
            token = get_otokoc_token()
            if not token:
                return []
            
            # Yeni token ile tekrar dene
            payload["Token"] = token
            response = requests.post(url, json=payload)
            response.raise_for_status()
            response_data = response.json()
        
        if 'Data' not in response_data or 'Invoices' not in response_data['Data']:
            print(f"‚ùå Otokoc API'den fatura verileri √ßekilemedi: Ge√ßersiz yanƒ±t formatƒ±")
            print(f"Yanƒ±t: {json.dumps(response_data, indent=2, ensure_ascii=False)}")
            return []
        
        invoices = response_data['Data']['Invoices']
        print(f"‚úÖ Otokoc API'den {len(invoices)} fatura verisi √ßekildi")
        
        # Yanƒ±t formatƒ±nƒ± kontrol et ve debug i√ßin yazdƒ±r
        if invoices and len(invoices) > 0:
            print(f"\nüîç √ñrnek fatura verisi:")
            print(json.dumps(invoices[0], indent=2, ensure_ascii=False))
        
        # Saat 16:00'dan sonraki faturalarƒ± filtrele
        filtered_invoices = []
        for invoice in invoices:
            # IslemSaati alanƒ±nƒ± kontrol et
            islem_saati = invoice.get('IslemSaati', '')
            if not islem_saati:
                # IslemSaati yoksa alternatif alanlarƒ± kontrol et
                islem_saati = invoice.get('InvoiceDate', '')
            
            if islem_saati:
                try:
                    # Tarih formatƒ±nƒ± kontrol et
                    if 'T' in islem_saati:
                        # ISO format: 2025-03-05T16:30:00
                        islem_datetime = datetime.fromisoformat(islem_saati.replace('Z', '+00:00'))
                    else:
                        # Diƒüer olasƒ± formatlar
                        try:
                            islem_datetime = datetime.strptime(islem_saati, '%Y-%m-%d %H:%M:%S')
                        except ValueError:
                            try:
                                islem_datetime = datetime.strptime(islem_saati, '%d.%m.%Y %H:%M:%S')
                            except ValueError:
                                islem_datetime = datetime.strptime(islem_saati, '%d.%m.%Y')
                    
                    # Saat kontrol√º - aynƒ± g√ºn 16:00'dan sonra mƒ±?
                    if islem_datetime.hour >= 16:
                        filtered_invoices.append(invoice)
                        print(f"‚úÖ Fatura kabul edildi: {invoice.get('InvoiceNo', 'N/A')} - ƒ∞≈ülem Saati: {islem_saati}")
                    else:
                        print(f"‚è≠Ô∏è Fatura filtrelendi (saat 16:00'dan √∂nce): {invoice.get('InvoiceNo', 'N/A')} - ƒ∞≈ülem Saati: {islem_saati}")
                except Exception as e:
                    print(f"‚ö†Ô∏è Tarih d√∂n√º≈üt√ºrme hatasƒ± ({islem_saati}): {str(e)}")
                    # Hata durumunda faturayƒ± dahil et (isteƒüe baƒülƒ±)
                    filtered_invoices.append(invoice)
            else:
                # ƒ∞≈ülem saati bilgisi yoksa faturayƒ± dahil et
                filtered_invoices.append(invoice)
                print(f"‚ö†Ô∏è ƒ∞≈ülem saati bilgisi olmayan fatura dahil edildi: {invoice.get('InvoiceNo', 'N/A')}")
        
        print(f"üîç Filtreleme sonucu: {len(filtered_invoices)}/{len(invoices)} fatura i≈ülenecek")
        
        # Verileri kiralamaVeri.json formatƒ±na d√∂n√º≈üt√ºr
        formatted_invoices = []
        for invoice in filtered_invoices:
            # InvoiceNo veya KANo alanƒ±nƒ± kontrol et
            ka_no = invoice.get('InvoiceNo', '')
            if not ka_no:
                ka_no = invoice.get('KANo', '')
                if not ka_no:
                    # Benzersiz bir ID olu≈ütur
                    ka_no = f"AUTO-{str(uuid.uuid4())[:8]}"
                    print(f"‚ö†Ô∏è Fatura numarasƒ± bulunamadƒ±, otomatik ID olu≈üturuldu: {ka_no}")
            
            formatted_invoice = {
                'KANo': ka_no,
                'VergiNumarasi': invoice.get('TaxNo', ''),
                'TumMusteriAdi': invoice.get('CustomerName', ''),
                'VergiDairesi': invoice.get('TaxOffice', ''),
                'Adres': invoice.get('Address', ''),
                'Il': invoice.get('City', ''),
                'Ilce': invoice.get('District', ''),
                'KDVOrani': invoice.get('VatRate', 0),
                'KDVTutari': invoice.get('VatAmount', 0),
                'KDVsizTutar': invoice.get('NetAmount', 0),
                'KDVliToplamTutar': invoice.get('GrossAmount', 0),
                'IslemSaati': invoice.get('IslemSaati', '')
            }
            formatted_invoices.append(formatted_invoice)
        
        return formatted_invoices
    except requests.exceptions.RequestException as e:
        print(f"‚ùå Otokoc API fatura verileri √ßekme hatasƒ±: {str(e)}")
        traceback.print_exc()
        return []
    except Exception as e:
        print(f"‚ùå Otokoc API fatura verileri √ßekme hatasƒ±: {str(e)}")
        traceback.print_exc()
        return []

def edm_login():
    try:
        # Ger√ßek EDM sistemi
        wsdl_url = "https://portal2.edmbilisim.com.tr/EFaturaEDM/EFaturaEDM.svc?wsdl"
        client = Client(wsdl=wsdl_url)
        
        action_date = datetime.now().strftime("%Y-%m-%dT%H:%M:%S.%f")[:-3] + "+03:00"
        login_request_header = {
            "SESSION_ID": str(uuid.uuid4()),
            "CLIENT_TXN_ID": str(uuid.uuid4()),
            "ACTION_DATE": action_date,
            "REASON": "E-fatura/E-Ar≈üiv g√∂nder-al testleri i√ßin",
            "APPLICATION_NAME": "EDM MINI CONNECTOR v1.0",
            "HOSTNAME": "MDORA17",
            "CHANNEL_NAME": "TEST",
            "COMPRESSED": "N"
        }

        login_request = {
            "REQUEST_HEADER": login_request_header,
            "USER_NAME": "otomasyon",
            "PASSWORD": "123456789"
        }

        print("\nüîë EDM Login yapƒ±lƒ±yor...")
        login_response = client.service.Login(**login_request)
        session_id = login_response.SESSION_ID
        print(f"‚úÖ EDM Login ba≈üarƒ±lƒ± - Session ID: {session_id}")
        return client, session_id

    except Exception as e:
        print(f"‚ùå EDM Login hatasƒ±: {str(e)}")
        traceback.print_exc()
        return None, None

def check_user_and_get_info(client, session_id, vkn):
    print("\n" + "="*50)
    print(f"üîç CheckUser ƒ∞≈ülemi Ba≈ülatƒ±ldƒ± - VKN: {vkn}")
    print("="*50)
    
    action_date = datetime.now().strftime("%Y-%m-%dT%H:%M:%S.%f")[:-3] + "+03:00"

    request_header = {
        "SESSION_ID": session_id,
        "CLIENT_TXN_ID": str(uuid.uuid4()),
        "ACTION_DATE": action_date,
        "REASON": "E-fatura/E-Ar≈üiv g√∂nder-al testleri i√ßin",
        "APPLICATION_NAME": "EDM MINI CONNECTOR v1.0",
        "HOSTNAME": "MDORA17",
        "CHANNEL_NAME": "TEST",
        "COMPRESSED": "N"
    }

    user = {
        "IDENTIFIER": vkn
    }

    try:
        print("\nüì§ CheckUser ƒ∞steƒüi G√∂nderiliyor...")
        print(f"Request Header: {json.dumps(request_header, indent=2)}")
        print(f"User Data: {json.dumps(user, indent=2)}")
        
        response = client.service.CheckUser(REQUEST_HEADER=request_header, USER=user)
        print("\nüì• CheckUser Yanƒ±tƒ± Alƒ±ndƒ±")
        
        serialized_response = serialize_object(response)
        print("\nCheckUser Response Details:")
        print("-" * 50)
        print(json.dumps(serialized_response, indent=2, ensure_ascii=False))
        print("-" * 50)

        # Response bo≈ü dizi kontrol√º
        if not response or len(response) == 0:
            print("\n‚ö†Ô∏è Kullanƒ±cƒ± e-fatura sisteminde bulunamadƒ±")
            print("‚ö†Ô∏è E-Ar≈üiv faturasƒ± olarak i≈üleme devam edilecek")
            # E-Ar≈üiv i√ßin null deƒüerler d√∂nd√ºr, alias null olduƒüunda E-Ar≈üiv olarak i≈ülenecek
            return None, None, None, None, None, None
        
        print("\n‚úÖ Kullanƒ±cƒ± e-fatura sisteminde bulundu")
        
        # Response'un ilk elemanƒ±ndan ALIAS deƒüerini al
        first_user = response[0]
        alias = first_user.ALIAS if hasattr(first_user, 'ALIAS') else None
        print(f"üìß Alias: {alias}")
        
        if not alias:
            print("\n‚ö†Ô∏è Alias bulunamadƒ±")
            print("‚ö†Ô∏è E-Ar≈üiv faturasƒ± olarak i≈üleme devam edilecek")
            return None, None, None, None, None, None
            
        # TURMOB bilgilerini al
        print("\nüîÑ TURMOB Bilgileri Alƒ±nƒ±yor...")
        turmob_header = {
            "SESSION_ID": session_id,
            "CLIENT_TXN_ID": str(uuid.uuid4()),
            "ACTION_DATE": datetime.now().strftime("%Y-%m-%d"),
            "REASON": "test",
            "APPLICATION_NAME": "EDMTEST",
            "HOSTNAME": "BALCIAS",
            "CHANNEL_NAME": "EDM",
            "COMPRESSED": "N"
        }
        
        try:
            print("\nüì§ TURMOB ƒ∞steƒüi G√∂nderiliyor...")
            print(f"VKN: {vkn}")
            print(f"Session ID: {session_id}")
            print(f"TURMOB Request Header: {json.dumps(turmob_header, indent=2)}")
            
            try:
                turmob_response = client.service.GetTurmob(REQUEST_HEADER=turmob_header, VKN=vkn)
            except zeep.exceptions.Fault as soap_error:
                print(f"\n‚ùå SOAP Hatasƒ±:")
                print(f"Hata Mesajƒ±: {soap_error.message}")
                if hasattr(soap_error, 'detail'):
                    detail_xml = ET.tostring(soap_error.detail, encoding='unicode')
                    print(f"Hata Detayƒ± XML: {detail_xml}")
                print(f"Hata Kodu: {getattr(soap_error, 'code', 'Kod yok')}")
                return alias, None, None, None, None, None
            
            print("\nüì• TURMOB Ham Yanƒ±t:")
            print("-" * 50)
            print(turmob_response)
            print("-" * 50)
            
            if hasattr(turmob_response, 'ERROR'):
                print(f"\n‚ùå TURMOB Hatasƒ±: {turmob_response.ERROR}")
                return alias, None, None, None, None, None
            
            serialized_turmob = serialize_object(turmob_response)
            print("\nüì• TURMOB Serialize Edilmi≈ü Yanƒ±t:")
            print("-" * 50)
            print(json.dumps(serialized_turmob, indent=2, ensure_ascii=False))
            print("-" * 50)
            
            # Yanƒ±t kontrol√º
            if not serialized_turmob:
                print("\n‚ö†Ô∏è TURMOB yanƒ±tƒ± bo≈ü")
                return alias, None, None, None, None, None
            
            # TURMOB bilgilerini al
            vergi_dairesi = serialized_turmob.get('vergiDairesiAdi', '')
            unvan = serialized_turmob.get('kimlikUnvani', '')
            
            # Adres bilgileri
            adres_bilgileri = serialized_turmob.get('adresBilgileri', {}).get('AdresBilgileri', [{}])[0]
            
            # Adres bile≈üenlerini birle≈ütir
            adres_parcalari = [
                adres_bilgileri.get('mahalleSemt', ''),
                adres_bilgileri.get('caddeSokak', ''),
                adres_bilgileri.get('disKapiNo', ''),
                adres_bilgileri.get('icKapiNo', '')
            ]
            tam_adres = ' '.join(filter(None, adres_parcalari))
            il = adres_bilgileri.get('ilAdi', '')
            ilce = adres_bilgileri.get('ilceAdi', '')
            
            print("\nüìã TURMOB Bilgileri:")
            print(f"Vergi Dairesi: {vergi_dairesi}")
            print(f"Unvan: {unvan}")
            print(f"Adres: {tam_adres}")
            print(f"ƒ∞l: {il}")
            print(f"ƒ∞l√ße: {ilce}")
            
            return alias, vergi_dairesi, unvan, tam_adres, il, ilce
            
        except Exception as e:
            print(f"\n‚ùå TURMOB bilgileri alƒ±nƒ±rken hata: {str(e)}")
            traceback.print_exc()
            return alias, None, None, None, None, None

    except Exception as e:
        print(f"\n‚ùå CheckUser i≈üleminde hata: {str(e)}")
        traceback.print_exc()
        return None, None, None, None, None, None

def send_telegram_notification(message):
    try:
        # Ger√ßek token ve chat ID'yi kullan (maskelenmi≈ü deƒüil)
        bot_token = "7846367311:AAEGOEcHElmtmMJfU9GznWEi5ZELfaD4U7Y"  # Ger√ßek token'ƒ± buraya yazƒ±n
        chat_id = "-1002470063488"  # Ger√ßek chat ID'yi buraya yazƒ±n
        
        # Debug i√ßin token ve chat ID'yi yazdƒ±r
        print(f"üîë Bot Token: {bot_token}")
        print(f"üí¨ Chat ID: {chat_id}")
        
        url = f"https://api.telegram.org/bot{bot_token}/sendMessage"
        payload = {
            "chat_id": chat_id,
            "text": message,
            "parse_mode": "HTML"
        }
        
        # Debug i√ßin URL'yi yazdƒ±r
        print(f"üåê API URL: {url}")
        
        # ƒ∞steƒüi g√∂nder ve yanƒ±tƒ± al
        response = requests.post(url, data=payload)
        
        # Yanƒ±t detaylarƒ±nƒ± yazdƒ±r
        print(f"üì° Telegram API Yanƒ±tƒ±:")
        print(f"Durum Kodu: {response.status_code}")
        print(f"Yanƒ±t ƒ∞√ßeriƒüi: {response.text}")
        
        if response.status_code == 200:
            print(f"‚úÖ Telegram bildirimi g√∂nderildi")
        else:
            print(f"‚ùå Telegram bildirimi g√∂nderilemedi: {response.text}")
            
    except Exception as e:
        print(f"‚ùå Telegram bildirimi g√∂nderilirken hata: {str(e)}")
        traceback.print_exc()

def update_xml_and_load(client, session_id, vkn, alias, vergi_dairesi, unvan, tam_adres, il, ilce, kayit=None):
    try:
        print("\nüìù XML g√ºncelleniyor...")
        
        # E-Ar≈üiv kontrol√º
        is_earchive = not alias  # alias yoksa E-Ar≈üiv
        print(f"‚úÖ Fatura tipi: {'E-Ar≈üiv' if is_earchive else 'E-Fatura'}")
        
        # Kayƒ±t verileri varsa, bunlarƒ± kullan
        if kayit:
            # Kayƒ±t verilerini formatla
            formatted_invoice_data = {
                'VergiNumarasi': kayit.get('VergiNumarasi', ''),
                'TumMusteriAdi': kayit.get('TumMusteriAdi', ''),  # ERTUTECH yazƒ±sƒ±nƒ± kaldƒ±rdƒ±k
                'KDVOrani': kayit.get('KDVOrani', 0),
                'KDVTutari': kayit.get('KDVTutari', 0),
                'KDVsizTutar': kayit.get('KDVsizTutar', 0),
                'KDVliToplamTutar': kayit.get('KDVliToplamTutar', 0),
                'KiraGunu': kayit.get('KiraGunu', '1'),
                'KANo': kayit.get('KANo', ''),
                'Adres': tam_adres or kayit.get('Adres', ''),
                'Il': il or kayit.get('Il', ''),
                'Ilce': ilce or kayit.get('Ilce', ''),
                'VergiDairesi': vergi_dairesi or kayit.get('VergiDairesi', ''),
                'KiraTipi': kayit.get('KiraTipi', ''),
                'PlakaNo': kayit.get('PlakaNo', ''),
                'IslemSaati': kayit.get('IslemSaati', '')
            }
            print(f"‚úÖ Fatura verileri hazƒ±rlandƒ±: {json.dumps(formatted_invoice_data, indent=2, ensure_ascii=False)}")
        else:
            print("‚ö†Ô∏è Kayƒ±t verileri bulunamadƒ±, sadece m√º≈üteri bilgileri g√ºncellenecek")
            formatted_invoice_data = None
        
        # XML dosyasƒ±nƒ± oku ve namespace'leri koru
        ET.register_namespace('cac', 'urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2')
        ET.register_namespace('cbc', 'urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2')
        ET.register_namespace('ext', 'urn:oasis:names:specification:ubl:schema:xsd:CommonExtensionComponents-2')
        ET.register_namespace('xsi', 'http://www.w3.org/2001/XMLSchema-instance')
        ET.register_namespace('xades', 'http://uri.etsi.org/01903/v1.3.2#')
        ET.register_namespace('udt', 'urn:un:unece:uncefact:data:specification:UnqualifiedDataTypesSchemaModule:2')
        ET.register_namespace('ubltr', 'urn:oasis:names:specification:ubl:schema:xsd:TurkishCustomizationExtensionComponents')
        ET.register_namespace('qdt', 'urn:oasis:names:specification:ubl:schema:xsd:QualifiedDatatypes-2')
        ET.register_namespace('ds', 'http://www.w3.org/2000/09/xmldsig#')
        
        tree = ET.parse('ornek.xml')
        root = tree.getroot()
        
        namespaces = {
            'cac': 'urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2',
            'cbc': 'urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2'
        }

        # G√ºncel tarih ve saat
        current_date = datetime.now().strftime('%Y-%m-%d')
        current_time = datetime.now().strftime('%H:%M:%S')

        # T√ºm IssueDate elementlerini g√ºncelle
        for issue_date in root.findall('.//cbc:IssueDate', namespaces):
            issue_date.text = current_date
            print(f"‚úÖ IssueDate g√ºncellendi: {current_date}")

        # IssueTime elementini g√ºncelle
        issue_time = root.find('.//cbc:IssueTime', namespaces)
        if issue_time is not None:
            issue_time.text = current_time
            print(f"‚úÖ IssueTime g√ºncellendi: {current_time}")

        # UUID ve ID g√ºncelle
        uuid_element = root.find('.//cbc:UUID', namespaces)
        id_element = root.find('.//cbc:ID', namespaces)
        
        # Yeni UUID olu≈ütur
        new_uuid = str(uuid.uuid4())
        
        # UUID g√ºncelle
        if uuid_element is not None:
            uuid_element.text = new_uuid
            print(f"‚úÖ UUID g√ºncellendi: {new_uuid}")
        
        # ProfileID g√ºncelleme - E-Ar≈üiv kontrol√º
        profile_id = root.find('.//cbc:ProfileID', namespaces)
        if profile_id is not None:
            if is_earchive:
                profile_id.text = "EARSIVFATURA"
                print("‚úÖ ProfileID EARSIVFATURA olarak g√ºncellendi")
            else:
                profile_id.text = "TICARIFATURA"
                print("‚úÖ ProfileID TICARIFATURA olarak g√ºncellendi")

        # AccountingCustomerParty g√ºncellemeleri
        customer = root.find('.//cac:AccountingCustomerParty', namespaces)
        if customer is not None:
            party = customer.find('.//cac:Party', namespaces)
            if party is not None:
                # VKN/TCKN g√ºncelleme
                id_element = party.find('.//cac:PartyIdentification/cbc:ID[@schemeID]', namespaces)
                if id_element is not None:
                    if is_earchive:
                        # E-Ar≈üiv i√ßin TCKN olarak ayarla
                        id_element.set('schemeID', 'TCKN')
                        id_element.text = vkn
                        print(f"‚úÖ M√º≈üteri TCKN g√ºncellendi: {vkn}")
                    else:
                        # E-Fatura i√ßin VKN olarak ayarla
                        id_element.set('schemeID', 'VKN')
                        id_element.text = vkn
                        print(f"‚úÖ M√º≈üteri VKN g√ºncellendi: {vkn}")
                
                # Unvan g√ºncelle
                name_element = party.find('.//cac:PartyName/cbc:Name', namespaces)
                if name_element is not None:
                    # Fatura tipine g√∂re unvan kaynaƒüƒ±nƒ± belirle
                    if is_earchive:
                        # E-Ar≈üiv i√ßin JSON'dan gelen TumMusteriAdi kullan
                        if formatted_invoice_data:
                            name_element.text = formatted_invoice_data['TumMusteriAdi']
                            print(f"‚úÖ M√º≈üteri unvanƒ± (E-Ar≈üiv i√ßin JSON'dan) g√ºncellendi: {name_element.text}")
                        else:
                            name_element.text = unvan if unvan else ""
                            print(f"‚úÖ M√º≈üteri unvanƒ± (E-Ar≈üiv i√ßin) g√ºncellendi: {name_element.text}")
                    else:
                        # E-Fatura i√ßin TURMOB'dan gelen kimlikUnvani kullan
                        name_element.text = unvan if unvan else ""
                        print(f"‚úÖ M√º≈üteri unvanƒ± (E-Fatura i√ßin TURMOB'dan) g√ºncellendi: {name_element.text}")
                
                # Person elementini kontrol et
                person_element = party.find('.//cac:Person', namespaces)
                
                if is_earchive:
                    # E-Ar≈üiv i√ßin Person elementini ekle veya g√ºncelle
                    if person_element is None:
                        # Person elementi yoksa olu≈ütur
                        person_element = ET.SubElement(party, '{urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2}Person')
                        ET.SubElement(person_element, '{urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2}FirstName')
                        ET.SubElement(person_element, '{urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2}FamilyName')
                        print("‚úÖ Person elementi olu≈üturuldu")
                    
                    # Ad-Soyad b√∂lme i≈ülemi
                    # E-Ar≈üiv i√ßin JSON'dan gelen TumMusteriAdi kullan
                    customer_name = formatted_invoice_data['TumMusteriAdi'] if formatted_invoice_data else unvan
                    if customer_name:
                        name_parts = customer_name.split()
                        if len(name_parts) > 0:
                            last_name = name_parts[-1]  # Son kelime soyad
                            first_name = " ".join(name_parts[:-1]) if len(name_parts) > 1 else ""  # Geri kalan kƒ±sƒ±m ad
                            
                            # FirstName g√ºncelle
                            first_name_element = person_element.find('./cbc:FirstName', namespaces)
                            if first_name_element is not None:
                                first_name_element.text = first_name
                                print(f"‚úÖ M√º≈üteri adƒ± g√ºncellendi: {first_name}")
                            
                            # FamilyName g√ºncelle
                            family_name_element = person_element.find('./cbc:FamilyName', namespaces)
                            if family_name_element is not None:
                                family_name_element.text = last_name
                                print(f"‚úÖ M√º≈üteri soyadƒ± g√ºncellendi: {last_name}")
                else:
                    # E-Fatura i√ßin Person elementini kaldƒ±r
                    if person_element is not None:
                        party.remove(person_element)
                        print("‚úÖ Person elementi kaldƒ±rƒ±ldƒ± (E-Fatura i√ßin gerekli deƒüil)")
                
                # Adres g√ºncelle
                address_element = party.find('.//cac:PostalAddress/cbc:BuildingName', namespaces)
                if address_element is not None:
                    address_element.text = tam_adres
                    print(f"‚úÖ M√º≈üteri adresi g√ºncellendi")
                
                # ƒ∞l√ße g√ºncelle
                subdivision_element = party.find('.//cac:PostalAddress/cbc:CitySubdivisionName', namespaces)
                if subdivision_element is not None:
                    subdivision_element.text = ilce
                    print(f"‚úÖ M√º≈üteri il√ßesi g√ºncellendi: {ilce}")
                
                # ƒ∞l g√ºncelle
                city_element = party.find('.//cac:PostalAddress/cbc:CityName', namespaces)
                if city_element is not None:
                    city_element.text = il
                    print(f"‚úÖ M√º≈üteri ili g√ºncellendi: {il}")
                
                # Vergi dairesi g√ºncelle
                tax_scheme_element = party.find('.//cac:PartyTaxScheme/cac:TaxScheme/cbc:Name', namespaces)
                if tax_scheme_element is not None:
                    tax_scheme_element.text = vergi_dairesi if vergi_dairesi else ""
                    print(f"‚úÖ M√º≈üteri vergi dairesi g√ºncellendi: {vergi_dairesi}")

        # Kayƒ±t verileri varsa, fatura detaylarƒ±nƒ± g√ºncelle
        if formatted_invoice_data:
            # Item altƒ±ndaki cbc:Name elementini PlakaNo ile g√ºncelle
            item_name_element = root.find(".//cac:Item/cbc:Name", namespaces)
            if item_name_element is not None and formatted_invoice_data['PlakaNo']:
                item_name_element.text = f"{formatted_invoice_data['PlakaNo']} PLAKALI ARA√á Kƒ∞RALAMA BEDELƒ∞"
                print(f"‚úÖ Plaka g√ºncellendi: {item_name_element.text}")

            # InvoicedQuantity g√ºncelleme (Kira g√ºn√º)
            invoiced_quantity_element = root.find(".//cbc:InvoicedQuantity", namespaces)
            if invoiced_quantity_element is not None:
                invoiced_quantity_element.text = str(int(float(formatted_invoice_data['KiraGunu'])))
                print(f"‚úÖ Kira g√ºn√º g√ºncellendi: {invoiced_quantity_element.text}")

            # PriceAmount g√ºncelleme (G√ºnl√ºk fiyat)
            price_amount_element = root.find(".//cbc:PriceAmount", namespaces)
            if price_amount_element is not None:
                try:
                    price_per_day = float(formatted_invoice_data['KDVsizTutar']) / float(formatted_invoice_data['KiraGunu'])
                    price_amount_element.text = f"{price_per_day:.2f}"
                    print(f"‚úÖ G√ºnl√ºk fiyat g√ºncellendi: {price_amount_element.text}")
                except ZeroDivisionError:
                    price_amount_element.text = "0.00"
                    print("‚ö†Ô∏è Kira g√ºn√º sƒ±fƒ±r olduƒüu i√ßin g√ºnl√ºk fiyat 0.00 olarak ayarlandƒ±")

            # KDV Oranƒ± g√ºncelleme
            percent_element = root.find(".//cbc:Percent", namespaces)
            if percent_element is not None:
                percent_element.text = str(int(formatted_invoice_data['KDVOrani']))
                print(f"‚úÖ KDV oranƒ± g√ºncellendi: {percent_element.text}")

            # TaxAmount g√ºncelleme (KDV tutarƒ±)
            tax_amount_elements = root.findall(".//cbc:TaxAmount", namespaces)
            for tax_amount_element in tax_amount_elements:
                tax_amount_element.text = f"{formatted_invoice_data['KDVTutari']:.2f}"
                print(f"‚úÖ KDV tutarƒ± g√ºncellendi: {tax_amount_element.text}")

            # KDVsiz tutar ile g√ºncellenecek elementler
            elements_to_update_kdvsiz = [
                ".//cbc:TaxableAmount",
                ".//cbc:LineExtensionAmount",
                ".//cbc:TaxExclusiveAmount"
            ]

            for xpath in elements_to_update_kdvsiz:
                elements = root.findall(xpath, namespaces)
                for element in elements:
                    if element is not None:
                        element.text = str(formatted_invoice_data['KDVsizTutar'])
                        print(f"‚úÖ KDVsiz tutar g√ºncellendi ({xpath}): {element.text}")

            # KDVli tutar ile g√ºncellenecek elementler
            elements_to_update_kdvli = [
                ".//cbc:TaxInclusiveAmount",
                ".//cbc:PayableAmount"
            ]

            for xpath in elements_to_update_kdvli:
                element = root.find(xpath, namespaces)
                if element is not None:
                    element.text = str(formatted_invoice_data['KDVliToplamTutar'])
                    print(f"‚úÖ KDVli tutar g√ºncellendi ({xpath}): {element.text}")

            # Toplam tutarƒ± yazƒ±ya √ßevir
            toplam_tutar = float(formatted_invoice_data['KDVliToplamTutar'])
            tutar_yazi = sayi_to_yazi(toplam_tutar)

            # Note elementlerini g√ºncelle
            note_elements = root.findall(".//cbc:Note", namespaces)
            if note_elements and len(note_elements) >= 2:
                note_elements[0].text = f"Yazƒ± ile: # {tutar_yazi} #"
                note_elements[1].text = f"KA: {formatted_invoice_data['KANo']}"
                print(f"‚úÖ Note elementleri g√ºncellendi")

        # G√ºncellenmi≈ü XML'i kaydet
        updated_xml_path = 'updated_invoice.xml'
        tree.write(updated_xml_path, encoding='UTF-8', xml_declaration=True)
        print(f"‚úÖ G√ºncellenmi≈ü XML kaydedildi: {updated_xml_path}")
        
        # XML dosyasƒ±nƒ± oku ve base64 ile kodla
        with open(updated_xml_path, 'rb') as f:
            xml_content = f.read()
        
        encoded_content = base64.b64encode(xml_content).decode('utf-8')
        print(f"‚úÖ XML i√ßeriƒüi base64 ile kodlandƒ± ({len(encoded_content)} karakter)")
        
        # LoadInvoice request header
        request_header = {
            "SESSION_ID": session_id,
            "CLIENT_TXN_ID": str(uuid.uuid4()),
            "ACTION_DATE": datetime.now().strftime("%Y-%m-%dT%H:%M:%S.%f")[:-3] + "+03:00",
            "REASON": "E-fatura/E-Ar≈üiv g√∂nder-al testleri i√ßin",
            "APPLICATION_NAME": "EDM MINI CONNECTOR v1.0",
            "HOSTNAME": "MDORA17",
            "CHANNEL_NAME": "TEST",
            "COMPRESSED": "N"
        }

        # Sender bilgileri
        sender = {
            "vkn": "8930043435",
            "alias": "urn:mail:urartugb@edmbilisim.com"
        }

        # Receiver bilgileri - E-Ar≈üiv i√ßin √∂zel ayarlama
        if is_earchive:
            receiver = {
                "vkn": vkn,
                "alias": ""  # E-Ar≈üiv i√ßin bo≈ü alias
            }
            print("‚ö†Ô∏è E-Ar≈üiv faturasƒ± i√ßin bo≈ü alias kullanƒ±lƒ±yor")
        else:
            receiver = {
                "vkn": vkn,
                "alias": alias  # CheckUser'dan gelen tam alias deƒüeri
            }

        print("\nüì§ LoadInvoice Bilgileri:")
        print(f"Sender: {json.dumps(sender, indent=2)}")
        print(f"Receiver: {json.dumps(receiver, indent=2)}")
        print(f"E-Ar≈üiv mi?: {is_earchive}")

        # Invoice i√ßeriƒüi
        invoice = {
            "TRXID": "0",
            "HEADER": {
                "SENDER": sender["vkn"],
                "RECEIVER": receiver["vkn"],
                "FROM": sender["alias"],
                "TO": receiver["alias"] if not is_earchive else "",  # E-Ar≈üiv i√ßin TO alanƒ±nƒ± bo≈ü bƒ±rak
                "INTERNETSALES": False,
                "EARCHIVE": is_earchive,  # E-Ar≈üiv durumuna g√∂re ayarla
                "EARCHIVE_REPORT_SENDDATE": "0001-01-01",
                "CANCEL_EARCHIVE_REPORT_SENDDATE": "0001-01-01",
            },
            "CONTENT": encoded_content
        }

        # Maksimum deneme sayƒ±sƒ±
        max_attempts = 3
        retry_delay = 5  # saniye
        
        for attempt in range(1, max_attempts + 1):
            try:
                print(f"\nüì§ LoadInvoice isteƒüi g√∂nderiliyor... (Deneme {attempt}/{max_attempts})")
                print(f"Request Header: {json.dumps(request_header, indent=2)}")
                
                # Parametreleri bir s√∂zl√ºk olarak hazƒ±rla
                load_params = {
                    "REQUEST_HEADER": request_header,
                    "SENDER": sender,
                    "RECEIVER": receiver,
                    "INVOICE": [invoice],
                    "GENERATEINVOICEIDONLOAD": True
                }
                
                # Timeout ve detaylƒ± loglama ekle
                import time
                print("‚è≥ LoadInvoice isteƒüi ba≈ülatƒ±lƒ±yor...")
                start_time = time.time()
                
                # ƒ∞steƒüi g√∂nder
                response = client.service.LoadInvoice(**load_params)
                
                end_time = time.time()
                print(f"‚úÖ LoadInvoice isteƒüi tamamlandƒ± ({end_time - start_time:.2f} saniye)")
                
                # Basit yanƒ±t kontrol√º
                print("\nüì• LoadInvoice yanƒ±tƒ± alƒ±ndƒ±")
                
                # Yanƒ±t i√ßeriƒüini basit ≈üekilde kontrol et
                if response is None:
                    print("‚ö†Ô∏è LoadInvoice yanƒ±tƒ± bo≈ü (None)")
                    if attempt < max_attempts:
                        print(f"‚è≥ {retry_delay} saniye bekleyip tekrar deneniyor...")
                        time.sleep(retry_delay)
                        continue
                
                # Yanƒ±tƒ± basit ≈üekilde logla
                print(f"Yanƒ±t tipi: {type(response)}")
                
                # Ba≈üarƒ± kontrol√º - basitle≈ütirilmi≈ü
                success = False
                error_msg = ""
                
                try:
                    if hasattr(response, 'INVOICE') and response.INVOICE:
                        invoice_header = response.INVOICE[0].HEADER
                        if hasattr(invoice_header, 'STATUS'):
                            status = invoice_header.STATUS
                            print(f"Fatura durumu: {status}")
                            
                            if status == 'LOAD - SUCCEED':
                                success = True
                                # Fatura ID ve UUID bilgilerini yazdƒ±r
                                if hasattr(invoice_header, 'ID'):
                                    print(f"üìÑ Fatura ID: {invoice_header.ID}")
                                if hasattr(invoice_header, 'UUID'):
                                    print(f"üîë Fatura UUID: {invoice_header.UUID}")
                    
                    if hasattr(response, 'ERROR'):
                        error_msg = response.ERROR
                except Exception as e:
                    print(f"‚ö†Ô∏è Yanƒ±t i≈ülenirken hata: {str(e)}")
                
                if success:
                    print("\n‚úÖ Fatura ba≈üarƒ±yla y√ºklendi")
                    
                    # Telegram bildirimi g√∂nder
                    fatura_tipi = "E-Ar≈üiv" if is_earchive else "E-Fatura"
                    fatura_id = invoice_header.ID if hasattr(invoice_header, 'ID') else "Bilinmiyor"
                    fatura_uuid = invoice_header.UUID if hasattr(invoice_header, 'UUID') else "Bilinmiyor"
                    
                    notification_message = f"""
<b>‚úÖ Fatura Ba≈üarƒ±yla Y√ºklendi</b>

<b>Fatura Bilgileri:</b>
üîπ <b>Fatura Tipi:</b> {fatura_tipi}
üîπ <b>Fatura ID:</b> {fatura_id}
üîπ <b>Fatura UUID:</b> {fatura_uuid}
üîπ <b>VKN/TCKN:</b> {vkn}
üîπ <b>M√º≈üteri:</b> {unvan}
üîπ <b>KA No:</b> {formatted_invoice_data.get('KANo', 'Bilinmiyor') if formatted_invoice_data else 'Bilinmiyor'}

<b>Tutar Bilgileri:</b>
"""
                    if formatted_invoice_data:
                        notification_message += f"""
üîπ <b>KDV Oranƒ±:</b> %{formatted_invoice_data['KDVOrani']}
üîπ <b>KDV Tutarƒ±:</b> {formatted_invoice_data['KDVTutari']} TL
üîπ <b>KDV'siz Tutar:</b> {formatted_invoice_data['KDVsizTutar']} TL
üîπ <b>Toplam Tutar:</b> {formatted_invoice_data['KDVliToplamTutar']} TL
"""
                    
                    notification_message += f"""
<b>ƒ∞≈ülem Tarihi:</b> {datetime.now().strftime('%d.%m.%Y %H:%M:%S')}
"""
                    
                    # Bildirimi g√∂nder
                    send_telegram_notification(notification_message)
                    
                    # Ba≈üarƒ±lƒ± i≈ülemi kaydet
                    if formatted_invoice_data and 'KANo' in formatted_invoice_data and formatted_invoice_data['KANo']:
                        save_processed_invoice(formatted_invoice_data['KANo'])
                    
                    return True
                else:
                    if error_msg:
                        print(f"\n‚ùå Fatura y√ºkleme ba≈üarƒ±sƒ±z: {error_msg}")
                        
                        # Gƒ∞B E-Fatura kapsamƒ±nda bulunmuyor hatasƒ± kontrol√º
                        if "Gƒ∞B E-Fatura kapsamƒ±nda bulunmuyor" in error_msg:
                            print("‚ö†Ô∏è Gƒ∞B sisteminde ge√ßici bir sorun olabilir.")
                            if attempt < max_attempts:
                                print(f"‚è≥ {retry_delay} saniye bekleyip tekrar deneniyor...")
                                time.sleep(retry_delay)
                                # Yeni bir session ID al
                                try:
                                    print("üîÑ Yeni oturum a√ßƒ±lƒ±yor...")
                                    new_client, new_session_id = edm_login()
                                    if new_client and new_session_id:
                                        client = new_client
                                        session_id = new_session_id
                                        request_header["SESSION_ID"] = session_id
                                        print(f"‚úÖ Yeni oturum a√ßƒ±ldƒ±: {session_id}")
                                    else:
                                        print("‚ùå Yeni oturum a√ßƒ±lamadƒ±")
                                except Exception as login_error:
                                    print(f"‚ùå Yeni oturum a√ßma hatasƒ±: {str(login_error)}")
                                continue
                        
                        # UUID √ßakƒ±≈ümasƒ± hatasƒ± kontrol√º
                        if "Daha √∂nce y√ºklediƒüiniz bir fatura" in error_msg:
                            print("‚ö†Ô∏è UUID √ßakƒ±≈ümasƒ± tespit edildi.")
                            if attempt < max_attempts:
                                print(f"‚è≥ Yeni UUID ile tekrar deneniyor...")
                                # Yeni UUID olu≈ütur
                                new_uuid = str(uuid.uuid4())
                                uuid_element = root.find('.//cbc:UUID', namespaces)
                                if uuid_element is not None:
                                    uuid_element.text = new_uuid
                                    print(f"‚úÖ UUID g√ºncellendi: {new_uuid}")
                                    
                                    # G√ºncellenmi≈ü XML'i kaydet
                                    tree.write(updated_xml_path, encoding='UTF-8', xml_declaration=True)
                                    
                                    # XML dosyasƒ±nƒ± oku ve base64 ile kodla
                                    with open(updated_xml_path, 'rb') as f:
                                        xml_content = f.read()
                                    
                                    encoded_content = base64.b64encode(xml_content).decode('utf-8')
                                    invoice["CONTENT"] = encoded_content
                                    
                                    continue
                    else:
                        print("\n‚ùå Fatura y√ºkleme ba≈üarƒ±sƒ±z")
                        
                        # Maksimum deneme sayƒ±sƒ±na ula≈üƒ±ldƒ±ysa hata bildirimi g√∂nder
                        if attempt >= max_attempts:
                            error_notification = f"""
<b>‚ùå Fatura Y√ºkleme Ba≈üarƒ±sƒ±z</b>

<b>Fatura Bilgileri:</b>
üîπ <b>Fatura Tipi:</b> {"E-Ar≈üiv" if is_earchive else "E-Fatura"}
üîπ <b>VKN/TCKN:</b> {vkn}
üîπ <b>M√º≈üteri:</b> {unvan}

<b>Hata Mesajƒ±:</b>
Bilinmeyen hata

<b>ƒ∞≈ülem Tarihi:</b> {datetime.now().strftime('%d.%m.%Y %H:%M:%S')}
"""
                            send_telegram_notification(error_notification)
                    
                    if attempt < max_attempts:
                        print(f"‚è≥ {retry_delay} saniye bekleyip tekrar deneniyor...")
                        time.sleep(retry_delay)
                        continue
                    
                    return False
                    
            except Exception as e:
                print(f"\n‚ùå LoadInvoice hatasƒ±: {str(e)}")
                traceback.print_exc()
                
                # Maksimum deneme sayƒ±sƒ±na ula≈üƒ±ldƒ±ysa hata bildirimi g√∂nder
                if attempt >= max_attempts:
                    error_notification = f"""
<b>‚ùå LoadInvoice ƒ∞≈ülemi Hatasƒ±</b>

<b>Fatura Bilgileri:</b>
üîπ <b>Fatura Tipi:</b> {"E-Ar≈üiv" if is_earchive else "E-Fatura"}
üîπ <b>VKN/TCKN:</b> {vkn}
üîπ <b>M√º≈üteri:</b> {unvan}

<b>Hata Mesajƒ±:</b>
{str(e)}

<b>ƒ∞≈ülem Tarihi:</b> {datetime.now().strftime('%d.%m.%Y %H:%M:%S')}
"""
                    send_telegram_notification(error_notification)
                
                if attempt < max_attempts:
                    print(f"‚è≥ {retry_delay} saniye bekleyip tekrar deneniyor... (Deneme {attempt}/{max_attempts})")
                    time.sleep(retry_delay)
                    continue
                
                return False
        
        # T√ºm denemeler ba≈üarƒ±sƒ±z oldu
        print("‚ùå Maksimum deneme sayƒ±sƒ±na ula≈üƒ±ldƒ±. ƒ∞≈ülem ba≈üarƒ±sƒ±z.")
        return False
            
    except Exception as e:
        print(f"\n‚ùå XML g√ºncelleme hatasƒ±: {str(e)}")
        traceback.print_exc()
        
        # XML g√ºncelleme hatasƒ± bildirimi g√∂nder
        error_notification = f"""
<b>‚ùå XML G√ºncelleme Hatasƒ±</b>

<b>Fatura Bilgileri:</b>
üîπ <b>VKN/TCKN:</b> {vkn}
üîπ <b>M√º≈üteri:</b> {unvan}

<b>Hata Mesajƒ±:</b>
{str(e)}

<b>ƒ∞≈ülem Tarihi:</b> {datetime.now().strftime('%d.%m.%Y %H:%M:%S')}
"""
        send_telegram_notification(error_notification)
        
        return False

# Sayƒ±yƒ± yazƒ±ya √ßeviren fonksiyon
def sayi_to_yazi(sayi):
    birler = ["", "Bƒ∞R", "ƒ∞Kƒ∞", "√ú√á", "D√ñRT", "BE≈û", "ALTI", "YEDƒ∞", "SEKƒ∞Z", "DOKUZ"]
    onlar = ["", "ON", "Yƒ∞RMƒ∞", "OTUZ", "KIRK", "ELLƒ∞", "ALTMI≈û", "YETMƒ∞≈û", "SEKSEN", "DOKSAN"]
    
    def yuzler_to_yazi(n):
        if n == 0:
            return ""
        elif n < 10:
            return birler[n]
        elif n < 100:
            return onlar[n // 10] + " " + birler[n % 10]
        else:
            if n // 100 == 1:
                return "Y√úZ " + yuzler_to_yazi(n % 100)
            else:
                return birler[n // 100] + " Y√úZ " + yuzler_to_yazi(n % 100)
    
    def binler_to_yazi(n):
        if n < 1000:
            return yuzler_to_yazi(n)
        elif n < 1000000:
            if n // 1000 == 1:
                return "Bƒ∞N " + yuzler_to_yazi(n % 1000)
            else:
                return yuzler_to_yazi(n // 1000) + " Bƒ∞N " + yuzler_to_yazi(n % 1000)
        else:
            return yuzler_to_yazi(n // 1000000) + " Mƒ∞LYON " + binler_to_yazi(n % 1000000)
    
    # Sayƒ±yƒ± tam ve kuru≈ü olarak ayƒ±r
    tam_kisim = int(sayi)
    kurus_kisim = int((sayi - tam_kisim) * 100 + 0.5)  # Yuvarlama
    
    # Tam kƒ±smƒ± yazƒ±ya √ßevir
    tam_yazi = binler_to_yazi(tam_kisim).strip()
    
    # Kuru≈ü kƒ±smƒ± yazƒ±ya √ßevir
    kurus_yazi = yuzler_to_yazi(kurus_kisim).strip()
    
    # Sonucu birle≈ütir
    if tam_kisim > 0 and kurus_kisim > 0:
        return f"{tam_yazi} T√úRK Lƒ∞RASI {kurus_yazi} KURU≈û"
    elif tam_kisim > 0:
        return f"{tam_yazi} T√úRK Lƒ∞RASI"
    elif kurus_kisim > 0:
        return f"{kurus_yazi} KURU≈û"
    else:
        return "SIFIR T√úRK Lƒ∞RASI"

# ƒ∞≈ülenmi≈ü faturalarƒ± y√ºkle
def load_processed_invoices():
    try:
        if os.path.exists(PROCESSED_INVOICES_FILE):
            with open(PROCESSED_INVOICES_FILE, 'r', encoding='utf-8') as f:
                return json.load(f)
        else:
            return {"processed_invoices": [], "last_check_time": None}
    except Exception as e:
        print(f"‚ùå ƒ∞≈ülenmi≈ü faturalar y√ºklenirken hata: {str(e)}")
        return {"processed_invoices": [], "last_check_time": None}

# ƒ∞≈ülenmi≈ü faturalarƒ± kaydet
def save_processed_invoice(ka_no):
    try:
        processed_data = load_processed_invoices()
        
        # KA numarasƒ± zaten i≈ülenmi≈üse ekleme
        if ka_no not in processed_data["processed_invoices"]:
            processed_data["processed_invoices"].append(ka_no)
        
        # Son kontrol zamanƒ±nƒ± g√ºncelle
        processed_data["last_check_time"] = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
        
        with open(PROCESSED_INVOICES_FILE, 'w', encoding='utf-8') as f:
            json.dump(processed_data, indent=2, ensure_ascii=False, fp=f)
        
        print(f"‚úÖ KA No: {ka_no} i≈ülenmi≈ü faturalar listesine eklendi")
        return True
    except Exception as e:
        print(f"‚ùå ƒ∞≈ülenmi≈ü fatura kaydedilirken hata: {str(e)}")
        return False

def process_new_invoices():
    try:
        # √ñnce i≈ülenmi≈ü faturalarƒ± y√ºkle
        processed_data = load_processed_invoices()
        processed_invoices = processed_data["processed_invoices"]
        
        # Otokoc API'den fatura verilerini √ßek
        invoice_data = get_invoice_data()
        
        if not invoice_data:
            print("‚ö†Ô∏è ƒ∞≈ülenecek fatura verisi bulunamadƒ±")
            return
        
        # ƒ∞≈ülenmemi≈ü faturalarƒ± filtrele
        unprocessed_invoices = []
        for kayit in invoice_data:
            ka_no = kayit.get('KANo', '')
            if ka_no and ka_no not in processed_invoices:
                unprocessed_invoices.append(kayit)
                print(f"‚úÖ ƒ∞≈ülenecek yeni fatura: KA No: {ka_no}")
            elif ka_no in processed_invoices:
                print(f"‚è≠Ô∏è Fatura zaten i≈ülenmi≈ü: KA No: {ka_no}")
            else:
                print(f"‚ö†Ô∏è KA No bulunamadƒ±, fatura atlanƒ±yor")
        
        if not unprocessed_invoices:
            print(f"\n‚úÖ ƒ∞≈ülenecek yeni fatura bulunamadƒ±. Toplam i≈ülenmi≈ü fatura: {len(processed_invoices)}")
            return
        
        # Yeni faturalar varsa EDM'ye baƒülan
        print(f"\nüìã Toplam {len(unprocessed_invoices)} yeni kayƒ±t i≈ülenecek")
        
        # EDM'ye baƒülan
        client, session_id = edm_login()
        if not client or not session_id:
            print("‚ùå EDM baƒülantƒ±sƒ± ba≈üarƒ±sƒ±z!")
            
            # Baƒülantƒ± hatasƒ± bildirimi
            error_notification = f"""
<b>‚ùå EDM Baƒülantƒ± Hatasƒ±</b>

<b>Hata Mesajƒ±:</b>
EDM sistemine baƒülanƒ±lamadƒ±.

<b>ƒ∞≈ülem Tarihi:</b> {datetime.now().strftime('%d.%m.%Y %H:%M:%S')}
"""
            send_telegram_notification(error_notification)
            return
        
        # ƒ∞≈ülem ba≈ülangƒ±√ß bildirimi
        start_notification = f"""
<b>üöÄ Yeni Fatura ƒ∞≈ülemleri Ba≈ülatƒ±ldƒ±</b>

<b>Toplam ƒ∞≈ülenecek Kayƒ±t:</b> {len(unprocessed_invoices)}
<b>Ba≈ülangƒ±√ß Tarihi:</b> {datetime.now().strftime('%d.%m.%Y %H:%M:%S')}
"""
        send_telegram_notification(start_notification)
        
        # Ba≈üarƒ±lƒ± ve ba≈üarƒ±sƒ±z i≈ülem saya√ßlarƒ±
        success_count = 0
        fail_count = 0

        # Her kayƒ±t i√ßin i≈ülem yap
        for index, kayit in enumerate(unprocessed_invoices, 1):
            vkn = kayit.get('VergiNumarasi')  # VergiNumarasi alanƒ±nƒ± kullan
            ka_no = kayit.get('KANo', 'Bilinmiyor')
            
            print(f"\n{'='*50}")
            print(f"üîÑ Kayƒ±t {index}/{len(unprocessed_invoices)} i≈üleniyor")
            print(f"üìù VKN: {vkn}, KA No: {ka_no}")
            print(f"{'='*50}")

            if not vkn:
                print("‚ùå VKN bulunamadƒ±, kayƒ±t atlanƒ±yor")
                fail_count += 1
                continue

            # Firma bilgilerini kontrol et
            alias, vergi_dairesi, unvan, tam_adres, il, ilce = check_user_and_get_info(client, session_id, vkn)
            
            # E-fatura m√ºkellefi deƒüilse veya bilgiler alƒ±namadƒ±ysa API'den gelen bilgileri kullan
            if not alias:
                print(f"\n‚ö†Ô∏è VKN: {vkn} - Firma e-fatura m√ºkellefi deƒüil, E-Ar≈üiv faturasƒ± olarak i≈ülenecek")
                # API'den gelen bilgileri kullan
                unvan = kayit.get('TumMusteriAdi', '')
                vergi_dairesi = kayit.get('VergiDairesi', '')
                tam_adres = kayit.get('Adres', '')
                il = kayit.get('Il', '')
                ilce = kayit.get('Ilce', '')
            else:
                print(f"\n‚úÖ VKN: {vkn} - Firma e-fatura m√ºkellefi, E-Fatura olarak i≈ülenecek")

            print("\nüìã Firma Bilgileri:")
            print(f"Unvan: {unvan}")
            print(f"VKN: {vkn}")
            print(f"Alias: {alias}")
            print(f"Vergi Dairesi: {vergi_dairesi}")
            print(f"Adres: {tam_adres}")
            print(f"ƒ∞l: {il}")
            print(f"ƒ∞l√ße: {ilce}")
            print(f"KA No: {ka_no}")

            # TURMOB'dan gelen adres bilgileri null ise API'den gelen bilgileri kullan
            if not tam_adres or not il or not ilce:
                print("\n‚ö†Ô∏è Adres bilgileri eksik, API'den gelen bilgiler kullanƒ±lƒ±yor")
                tam_adres = kayit.get('Adres', '')
                il = kayit.get('Il', '')
                ilce = kayit.get('Ilce', '')

            # XML g√ºncelle ve faturayƒ± y√ºkle - kayƒ±t verisini de g√∂nder
            if update_xml_and_load(client, session_id, vkn, alias, vergi_dairesi, unvan, tam_adres, il, ilce, kayit):
                print(f"\n‚úÖ VKN: {vkn}, KA No: {ka_no} - ƒ∞≈ülem ba≈üarƒ±yla tamamlandƒ±")
                success_count += 1
            else:
                print(f"\n‚ùå VKN: {vkn}, KA No: {ka_no} - ƒ∞≈ülem ba≈üarƒ±sƒ±z")
                fail_count += 1

            # ƒ∞≈ülemler arasƒ± kƒ±sa bekle
            time.sleep(1)

        print("\n‚úÖ T√ºm yeni kayƒ±tlar i≈ülendi")
        
        # ƒ∞≈ülem sonu√ß bildirimi
        end_notification = f"""
<b>üèÅ Yeni Fatura ƒ∞≈ülemleri Tamamlandƒ±</b>

<b>Sonu√ß √ñzeti:</b>
üîπ <b>Toplam ƒ∞≈ülenen Kayƒ±t:</b> {len(unprocessed_invoices)}
üîπ <b>Ba≈üarƒ±lƒ± ƒ∞≈ülem:</b> {success_count}
üîπ <b>Ba≈üarƒ±sƒ±z ƒ∞≈ülem:</b> {fail_count}
üîπ <b>Toplam ƒ∞≈ülenmi≈ü Fatura:</b> {len(processed_data["processed_invoices"]) + success_count}

<b>Biti≈ü Tarihi:</b> {datetime.now().strftime('%d.%m.%Y %H:%M:%S')}
"""
        send_telegram_notification(end_notification)

    except Exception as e:
        print(f"\n‚ùå Genel hata: {str(e)}")
        traceback.print_exc()
        
        # Genel hata bildirimi
        error_notification = f"""
<b>‚ùå Genel Hata</b>

<b>Hata Mesajƒ±:</b>
{str(e)}

<b>ƒ∞≈ülem Tarihi:</b> {datetime.now().strftime('%d.%m.%Y %H:%M:%S')}
"""
        send_telegram_notification(error_notification)

def main():
    try:
        print("\nüîÑ Fatura i≈üleme servisi ba≈ülatƒ±ldƒ±")
        
        # Ba≈ülangƒ±√ßta IP bilgilerini g√∂ster
        ip_info = get_my_ip()
        if ip_info:
            print(f"\nüì° Sistem IP Bilgileri:")
            print(f"   üåê Dƒ±≈ü IP: {ip_info['external_ip']}")
            print(f"   üè† Yerel IP: {ip_info['local_ip']}")
            print(f"   üíª Hostname: {ip_info['hostname']}")
        
        send_telegram_notification("<b>üöÄ Fatura ƒ∞≈üleme Servisi Ba≈ülatƒ±ldƒ±</b>")
        
        # ƒ∞lk token'ƒ± al
        if not get_otokoc_token():
            print("‚ùå Otokoc API token alƒ±namadƒ±, servis ba≈ülatƒ±lamƒ±yor")
            send_telegram_notification("<b>‚ùå Otokoc API token alƒ±namadƒ±, servis ba≈ülatƒ±lamƒ±yor</b>")
            return
        
        # ƒ∞lk √ßalƒ±≈ütƒ±rmada t√ºm faturalarƒ± i≈üle
        process_new_invoices()
        
        # Her 1 dakikada bir yeni faturalarƒ± kontrol et
        while True:
            print(f"\n‚è≥ Bir sonraki kontrol i√ßin bekleniyor... ({datetime.now().strftime('%H:%M:%S')})")
            time.sleep(60)  # 60 saniye bekle
            print(f"\nüîç Yeni faturalar kontrol ediliyor... ({datetime.now().strftime('%H:%M:%S')})")
            
            # Token kontrol√º
            check_and_refresh_token()
            
            # Yeni faturalarƒ± i≈üle
            process_new_invoices()
            
    except KeyboardInterrupt:
        print("\n‚ö†Ô∏è Kullanƒ±cƒ± tarafƒ±ndan durduruldu")
        send_telegram_notification("<b>‚ö†Ô∏è Fatura ƒ∞≈üleme Servisi Durduruldu</b>")
    except Exception as e:
        print(f"\n‚ùå Ana d√∂ng√ºde hata: {str(e)}")
        traceback.print_exc()
        
        error_notification = f"""
<b>‚ùå Fatura ƒ∞≈üleme Servisi Hatasƒ±</b>

<b>Hata Mesajƒ±:</b>
{str(e)}

<b>ƒ∞≈ülem Tarihi:</b> {datetime.now().strftime('%d.%m.%Y %H:%M:%S')}
"""
        send_telegram_notification(error_notification)

if __name__ == "__main__":
    main()